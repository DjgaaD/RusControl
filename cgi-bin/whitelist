#!/bin/sh
echo "Content-Type: text/html; charset=utf-8"
echo ""
METHOD="$REQUEST_METHOD"
ACTION=$(echo "$QUERY_STRING" | sed -n 's/.*action=\([^&]*\).*/\1/p')
MAC=$(echo "$QUERY_STRING" | sed -n 's/.*mac=\([^&]*\).*/\1/p')

if [ "$ACTION" = "add" ] && [ -n "$MAC" ]; then
    echo "$MAC" >> /etc/wifi_whitelist
    sort -u /etc/wifi_whitelist -o /etc/wifi_whitelist
fi

if [ "$ACTION" = "del" ] && [ -n "$MAC" ]; then
    sed -i "/$MAC/d" /etc/wifi_whitelist
fi

echo "<html><head><title>–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫</title><meta charset='utf-8'>"
echo "<style>"
echo "body{font-family:Arial,sans-serif;padding:20px;background:#f5f5f5}"
echo "table{border-collapse:collapse;margin:10px 0;background:white;box-shadow:0 0 10px rgba(0,0,0,0.1)}"
echo "th,td{padding:10px;border:1px solid #ddd;text-align:left}"
echo "th{background:#f2f2f2}"
echo ".form-box{background:white;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1);margin:20px 0;max-width:500px}"
echo ".del-btn{color:white;background:#d00;padding:4px 10px;border-radius:4px;text-decoration:none;font-size:0.85em}"
echo ".add-btn{color:white;background:#090;padding:4px 10px;border-radius:4px;text-decoration:none;font-size:0.85em}"
echo "</style></head><body>"
echo "<h1>‚ö™ –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫</h1>"
echo "<p><a href='/cgi-bin/devices'>‚Üê –ù–∞–∑–∞–¥ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º</a> | <a href='/cgi-bin/schedule'>‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a></p>"
echo "<p>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞ <strong>–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è</strong> –æ–±—â–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º '–í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞'</p>"

echo "<h2>–î–æ–±–∞–≤–∏—Ç—å –∏–∑ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö</h2>"
echo "<table><tr><th>MAC</th><th>–ò–º—è</th><th>IP</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>"
while IFS=' ' read -r ts mac ip name rest; do
    [ "$name" = "*" ] && name="‚Äî"
    if grep -qi "$mac" /etc/wifi_whitelist 2>/dev/null; then
        echo "<tr style='background:#e0ffe0'><td>$mac</td><td>$name</td><td>$ip</td><td>‚úÖ –í –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ</td></tr>"
    else
        echo "<tr><td>$mac</td><td>$name</td><td>$ip</td><td><a href='/cgi-bin/whitelist?action=add&mac=$mac' class='add-btn'>‚ûï –î–æ–±–∞–≤–∏—Ç—å</a></td></tr>"
    fi
done < /tmp/dhcp.leases
echo "</table>"

echo "<h2>–¢–µ–∫—É—â–∏–π –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫</h2>"
if [ -s /etc/wifi_whitelist ]; then
    echo "<table><tr><th>MAC</th><th>–ò–º—è</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>"
    while read mac; do
        [ -z "$mac" ] && continue
        NAME=$(grep -i "$mac" /tmp/dhcp.leases | awk '{print $4}')
        [ -z "$NAME" ] || [ "$NAME" = "*" ] && NAME="‚Äî"
        echo "<tr><td>$mac</td><td>$NAME</td><td><a href='/cgi-bin/whitelist?action=del&mac=$mac' class='del-btn'>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a></td></tr>"
    done < /etc/wifi_whitelist
    echo "</table>"
else
    echo "<p>–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç</p>"
fi
echo "</body></html>"
