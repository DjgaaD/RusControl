#!/bin/sh
echo "Content-Type: text/html; charset=utf-8"
echo ""
ROUTER_TIME=$(date '+%Y-%m-%dT%H:%M:%S')
THEME=$(echo "$QUERY_STRING" | sed -n 's/.*theme=\([^&]*\).*/\1/p')
if [ "$THEME" = "dark" ]; then
    BODY_CLASS="dark"
    BG="#1e1e2e"
else
    BODY_CLASS="light"
    BG="#f5f5f5"
fi
echo "<html><head><title>RusControl</title><meta charset='utf-8'>"
echo "<style>html,body{background:${BG};margin:0}</style>"
echo "<script>"
echo "var serverTime = new Date('${ROUTER_TIME}');"
echo "var offset = serverTime.getTime() - new Date().getTime();"
echo "function updateClock() {"
echo "  var now = new Date(new Date().getTime() + offset);"
echo "  var h = String(now.getHours()).padStart(2,'0');"
echo "  var m = String(now.getMinutes()).padStart(2,'0');"
echo "  var s = String(now.getSeconds()).padStart(2,'0');"
echo "  var d = String(now.getDate()).padStart(2,'0');"
echo "  var mo = String(now.getMonth()+1).padStart(2,'0');"
echo "  var y = now.getFullYear();"
echo "  document.getElementById('clock').textContent = h+':'+m+':'+s+' '+d+'.'+mo+'.'+y;"
echo "}"
echo "setInterval(updateClock, 1000);"
echo "window.onload = updateClock;"
echo "</script>"
echo "<style>"
echo "body{font-family:Arial,sans-serif;padding:10px;margin:0}"
echo "body.dark{background:#1e1e2e;color:#cdd6f4}"
echo "body.light{background:#f5f5f5;color:#333}"
echo "table{width:100%;border-collapse:collapse;margin-top:10px;box-shadow:0 0 10px rgba(0,0,0,0.1)}"
echo ".light table{background:white}"
echo ".dark table{background:#313244}"
echo "th,td{text-align:left;padding:8px 10px;border-bottom:1px solid #ddd;font-size:0.9em;white-space:nowrap}"
echo ".dark th,.dark td{border-bottom:1px solid #45475a}"
echo "th{background:#f2f2f2}"
echo ".dark th{background:#45475a}"
echo "tr:hover{background:#f9f9f9}"
echo ".dark tr:hover{background:#45475a}"
echo ".blocked{background:#ffe0e0}"
echo ".dark .blocked{background:#45171a}"
echo ".btn-block{color:white;background:#d00;padding:4px 10px;border-radius:4px;text-decoration:none;font-size:0.85em;display:inline-block}"
echo ".btn-unblock{color:white;background:#090;padding:4px 10px;border-radius:4px;text-decoration:none;font-size:0.85em;display:inline-block}"
echo ".btn-refresh{color:white;background:#0066cc;padding:6px 12px;border-radius:4px;text-decoration:none;font-size:0.85em;display:inline-block}"
echo ".btn-danger{color:white;background:#d00;padding:6px 12px;border-radius:4px;text-decoration:none;font-size:0.85em;display:inline-block}"
echo ".btn-success{color:white;background:#090;padding:6px 12px;border-radius:4px;text-decoration:none;font-size:0.85em;display:inline-block}"
echo ".mode-box{padding:10px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1);margin:10px 0}"
echo ".light .mode-box{background:white}"
echo ".dark .mode-box{background:#313244}"
echo ".header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}"
echo ".header h1{margin:0;font-size:1.3em}"
echo ".time-box{background:#333;color:#0f0;padding:6px 12px;border-radius:8px;font-family:monospace;font-size:1em}"
echo ".warn{color:#d00;font-size:0.8em;display:block;margin-top:8px}"
echo "</style></head><body class='${BODY_CLASS}'>"
echo "<div class='header'>"
echo "<h1>üì° –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Å–µ—Ç–∏</h1>"
echo "<div class='time-box' id='clock'>–∑–∞–≥—Ä—É–∑–∫–∞...</div>"
echo "</div>"
echo "<p style='margin-top:10px'><a href='/cgi-bin/devices?theme=${THEME}' class='btn-refresh'>üîÑ –û–±–Ω–æ–≤–∏—Ç—å</a></p>"

FIRST_IFACE=$(uci show wireless | grep "=wifi-iface" | head -1 | cut -d= -f1)
MACFILTER=$(uci get "${FIRST_IFACE}.macfilter" 2>/dev/null)

echo "<div class='mode-box'>"
if [ "$MACFILTER" = "allow" ]; then
    echo "<p>üîí <strong>–†–µ–∂–∏–º: –í–°–ï –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–´</strong> (–∫—Ä–æ–º–µ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞)</p>"
    echo "<a href='/cgi-bin/unblock_all_now' class='btn-success'>üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ—Ö</a>"
    echo "<span class='warn'>‚ö†Ô∏è WiFi –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞—Ç—Å—è</span>"
else
    echo "<p>üîì <strong>–†–µ–∂–∏–º: –í—Å–µ –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è</strong></p>"
    echo "<a href='/cgi-bin/block_all_now' class='btn-danger'>üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ—Ö</a>"
    echo "<span class='warn'>‚ö†Ô∏è WiFi –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞—Ç—Å—è</span>"
fi
echo "</div>"

BLOCKED_MACS=$(uci get "${FIRST_IFACE}.maclist" 2>/dev/null)

echo "<h2 style='font-size:1.1em'>üì∂ –ü–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ WiFi</h2>"
echo "<table><tr><th>MAC</th><th>–°–µ—Ç—å</th><th>–ò–º—è</th><th>IP</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>"
for ap in $(ubus list | grep hostapd); do
    IFACE=$(echo "$ap" | sed 's/hostapd\.//')
    SSID=$(iwinfo "$IFACE" info 2>/dev/null | grep "ESSID" | sed 's/.*ESSID: "\(.*\)"/\1/')
    for mac in $(iwinfo "$IFACE" assoclist 2>/dev/null | grep -oE '([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}'); do
        mac_lower=$(echo "$mac" | tr 'A-F' 'a-f')
        NAME=$(grep -i "$mac_lower" /tmp/dhcp.leases | awk '{print $4}')
        IP=$(grep -i "$mac_lower" /tmp/dhcp.leases | awk '{print $3}')
        [ -z "$NAME" ] || [ "$NAME" = "*" ] && NAME="‚Äî"
        [ -z "$IP" ] && IP="‚Äî"
        IS_WHITE=""
        grep -qi "$mac_lower" /etc/wifi_whitelist 2>/dev/null && IS_WHITE=" ‚ö™"
        echo "<tr><td>$mac_lower</td><td>$SSID</td><td>$NAME</td><td>$IP</td><td>‚úÖ${IS_WHITE}</td><td><a href='/cgi-bin/block?mac=$mac_lower' class='btn-block'>‚õî –ë–ª–æ–∫</a></td></tr>"
    done
done
echo "</table>"

if [ "$MACFILTER" = "deny" ] && [ -n "$BLOCKED_MACS" ]; then
    echo "<h2 style='font-size:1.1em'>üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</h2>"
    echo "<table><tr><th>MAC</th><th>–ò–º—è</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>"
    for mac in $BLOCKED_MACS; do
        NAME=$(grep -i "$mac" /tmp/dhcp.leases | awk '{print $4}')
        [ -z "$NAME" ] || [ "$NAME" = "*" ] && NAME="‚Äî"
        echo "<tr class='blocked'><td>$mac</td><td>$NAME</td><td><a href='/cgi-bin/unblock?mac=$mac' class='btn-unblock'>‚úÖ –†–∞–∑–±–ª–æ–∫</a></td></tr>"
    done
    echo "</table>"
fi
echo "</body></html>"
