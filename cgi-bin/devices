#!/bin/sh
echo "Content-Type: text/html; charset=utf-8"
echo ""
ROUTER_TIME=$(date '+%Y-%m-%dT%H:%M:%S')
echo "<html><head><title>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</title><meta charset='utf-8'><meta http-equiv='refresh' content='30'>"
echo "<script>"
echo "var serverTime = new Date('${ROUTER_TIME}');"
echo "var offset = serverTime.getTime() - new Date().getTime();"
echo "function updateClock() {"
echo "  var now = new Date(new Date().getTime() + offset);"
echo "  var h = String(now.getHours()).padStart(2,'0');"
echo "  var m = String(now.getMinutes()).padStart(2,'0');"
echo "  var s = String(now.getSeconds()).padStart(2,'0');"
echo "  var d = String(now.getDate()).padStart(2,'0');"
echo "  var mo = String(now.getMonth()+1).padStart(2,'0');"
echo "  var y = now.getFullYear();"
echo "  document.getElementById('clock').textContent = 'üïê ' + h+':'+m+':'+s+' '+d+'.'+mo+'.'+y;"
echo "}"
echo "setInterval(updateClock, 1000);"
echo "window.onload = updateClock;"
echo "</script>"
echo "<style>"
echo "body{font-family:Arial,sans-serif;padding:20px;background:#f5f5f5}"
echo "table{width:100%;border-collapse:collapse;margin-top:20px;background:white;box-shadow:0 0 10px rgba(0,0,0,0.1)}"
echo "th,td{text-align:left;padding:12px;border-bottom:1px solid #ddd}"
echo "th{background:#f2f2f2}"
echo "tr:hover{background:#f9f9f9}"
echo ".blocked{background:#ffe0e0}"
echo ".btn-block{color:white;background:#d00;padding:6px 14px;border-radius:4px;text-decoration:none}"
echo ".btn-unblock{color:white;background:#090;padding:6px 14px;border-radius:4px;text-decoration:none}"
echo ".btn-nav{color:white;background:#0066cc;padding:8px 16px;border-radius:4px;text-decoration:none;margin-right:8px}"
echo ".btn-danger{color:white;background:#d00;padding:8px 16px;border-radius:4px;text-decoration:none}"
echo ".btn-success{color:white;background:#090;padding:8px 16px;border-radius:4px;text-decoration:none}"
echo ".mode-box{background:white;padding:15px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1);margin:15px 0}"
echo ".header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}"
echo ".header h1{margin:0}"
echo ".time-box{background:#333;color:#0f0;padding:8px 16px;border-radius:8px;font-family:monospace;font-size:1.1em}"
echo ".warn{color:#d00;font-size:0.85em;display:block;margin-top:10px}"
echo "</style></head><body>"
echo "<div class='header'>"
echo "<h1>üì° –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Å–µ—Ç–∏</h1>"
echo "<div class='time-box' id='clock'>üïê –∑–∞–≥—Ä—É–∑–∫–∞...</div>"
echo "</div>"
echo "<p style='margin-top:15px'><a href='/cgi-bin/devices' class='btn-nav'>üîÑ –û–±–Ω–æ–≤–∏—Ç—å</a><a href='/cgi-bin/schedule' class='btn-nav'>‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a><a href='/cgi-bin/whitelist' class='btn-nav'>‚ö™ –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫</a></p>"

FIRST_IFACE=$(uci show wireless | grep "=wifi-iface" | head -1 | cut -d= -f1)
MACFILTER=$(uci get "${FIRST_IFACE}.macfilter" 2>/dev/null)

echo "<div class='mode-box'>"
if [ "$MACFILTER" = "allow" ]; then
    echo "<p>üîí <strong>–†–µ–∂–∏–º: –í–°–ï –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–´</strong> (–∫—Ä–æ–º–µ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞)</p>"
    echo "<a href='/cgi-bin/unblock_all_now' class='btn-success'>üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ—Ö</a>"
    echo "<span class='warn'>‚ö†Ô∏è WiFi –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞—Ç—Å—è</span>"
else
    echo "<p>üîì <strong>–†–µ–∂–∏–º: –í—Å–µ –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è</strong></p>"
    echo "<a href='/cgi-bin/block_all_now' class='btn-danger'>üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ—Ö</a>"
    echo "<span class='warn'>‚ö†Ô∏è WiFi –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞—Ç—Å—è</span>"
fi
echo "</div>"

BLOCKED_MACS=$(uci get "${FIRST_IFACE}.maclist" 2>/dev/null)

echo "<h2>üì∂ –ü–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ WiFi</h2>"
echo "<table><tr><th>MAC</th><th>–°–µ—Ç—å</th><th>–ò–º—è</th><th>IP</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>"
for ap in $(ubus list | grep hostapd); do
    IFACE=$(echo "$ap" | sed 's/hostapd\.//')
    SSID=$(iwinfo "$IFACE" info 2>/dev/null | grep "ESSID" | sed 's/.*ESSID: "\(.*\)"/\1/')
    for mac in $(iwinfo "$IFACE" assoclist 2>/dev/null | grep -oE '([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}'); do
        mac_lower=$(echo "$mac" | tr 'A-F' 'a-f')
        NAME=$(grep -i "$mac_lower" /tmp/dhcp.leases | awk '{print $4}')
        IP=$(grep -i "$mac_lower" /tmp/dhcp.leases | awk '{print $3}')
        [ -z "$NAME" ] || [ "$NAME" = "*" ] && NAME="‚Äî"
        [ -z "$IP" ] && IP="‚Äî"
        IS_WHITE=""
        grep -qi "$mac_lower" /etc/wifi_whitelist 2>/dev/null && IS_WHITE=" ‚ö™"
        echo "<tr><td>$mac_lower</td><td>$SSID</td><td>$NAME</td><td>$IP</td><td>‚úÖ –ê–∫—Ç–∏–≤–µ–Ω${IS_WHITE}</td><td><a href='/cgi-bin/block?mac=$mac_lower' class='btn-block'>‚õî –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</a></td></tr>"
    done
done
echo "</table>"

if [ "$MACFILTER" = "deny" ] && [ -n "$BLOCKED_MACS" ]; then
    echo "<h2>üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</h2>"
    echo "<table><tr><th>MAC</th><th>–ò–º—è</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>"
    for mac in $BLOCKED_MACS; do
        NAME=$(grep -i "$mac" /tmp/dhcp.leases | awk '{print $4}')
        [ -z "$NAME" ] || [ "$NAME" = "*" ] && NAME="‚Äî"
        echo "<tr class='blocked'><td>$mac</td><td>$NAME</td><td><a href='/cgi-bin/unblock?mac=$mac' class='btn-unblock'>‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</a></td></tr>"
    done
    echo "</table>"
fi
echo "</body></html>"
