#!/bin/sh
echo "Content-Type: text/html; charset=utf-8"
echo ""
METHOD="$REQUEST_METHOD"
if [ "$METHOD" = "POST" ]; then
    read -r POST_DATA
    MAC=$(echo "$POST_DATA" | sed -n 's/.*mac=\([^&]*\).*/\1/p')
    HOUR_ON=$(echo "$POST_DATA" | sed -n 's/.*hour_on=\([^&]*\).*/\1/p')
    MIN_ON=$(echo "$POST_DATA" | sed -n 's/.*min_on=\([^&]*\).*/\1/p')
    HOUR_OFF=$(echo "$POST_DATA" | sed -n 's/.*hour_off=\([^&]*\).*/\1/p')
    MIN_OFF=$(echo "$POST_DATA" | sed -n 's/.*min_off=\([^&]*\).*/\1/p')
    DAYS=""
    echo "$POST_DATA" | grep -q "d_mon=on" && DAYS="${DAYS}1,"
    echo "$POST_DATA" | grep -q "d_tue=on" && DAYS="${DAYS}2,"
    echo "$POST_DATA" | grep -q "d_wed=on" && DAYS="${DAYS}3,"
    echo "$POST_DATA" | grep -q "d_thu=on" && DAYS="${DAYS}4,"
    echo "$POST_DATA" | grep -q "d_fri=on" && DAYS="${DAYS}5,"
    echo "$POST_DATA" | grep -q "d_sat=on" && DAYS="${DAYS}6,"
    echo "$POST_DATA" | grep -q "d_sun=on" && DAYS="${DAYS}0,"
    DAYS=$(echo "$DAYS" | sed 's/,$//')
    if [ -n "$MAC" ] && [ -n "$HOUR_ON" ] && [ -n "$HOUR_OFF" ] && [ -n "$DAYS" ]; then
        sed -i "/#SCHED_${MAC}/d" /etc/crontabs/root 2>/dev/null
        touch /etc/crontabs/root
        if [ "$MAC" = "ALL" ]; then
            echo "${MIN_ON} ${HOUR_ON} * * ${DAYS} /www/cgi-bin/wifi_block_all #SCHED_${MAC}" >> /etc/crontabs/root
            echo "${MIN_OFF} ${HOUR_OFF} * * ${DAYS} /www/cgi-bin/wifi_unblock_all #SCHED_${MAC}" >> /etc/crontabs/root
        else
            echo "${MIN_ON} ${HOUR_ON} * * ${DAYS} /www/cgi-bin/wifi_block ${MAC} #SCHED_${MAC}" >> /etc/crontabs/root
            echo "${MIN_OFF} ${HOUR_OFF} * * ${DAYS} /www/cgi-bin/wifi_unblock ${MAC} #SCHED_${MAC}" >> /etc/crontabs/root
        fi
        /etc/init.d/cron restart
    fi
fi
ROUTER_TIME=$(date '+%Y-%m-%dT%H:%M:%S')
THEME=$(echo "$QUERY_STRING" | sed -n 's/.*theme=\([^&]*\).*/\1/p')
if [ "$THEME" = "dark" ]; then
    BODY_CLASS="dark"
    BG="#1e1e2e"
else
    BODY_CLASS="light"
    BG="#f5f5f5"
fi
echo "<html><head><title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</title><meta charset='utf-8'>"
echo "<style>html,body{background:${BG};margin:0}</style>"
echo "<script>"
echo "var serverTime = new Date('${ROUTER_TIME}');"
echo "var offset = serverTime.getTime() - new Date().getTime();"
echo "function updateClock() {"
echo "  var now = new Date(new Date().getTime() + offset);"
echo "  var h = String(now.getHours()).padStart(2,'0');"
echo "  var m = String(now.getMinutes()).padStart(2,'0');"
echo "  var s = String(now.getSeconds()).padStart(2,'0');"
echo "  var d = String(now.getDate()).padStart(2,'0');"
echo "  var mo = String(now.getMonth()+1).padStart(2,'0');"
echo "  var y = now.getFullYear();"
echo "  document.getElementById('clock').textContent = h+':'+m+':'+s+' '+d+'.'+mo+'.'+y;"
echo "}"
echo "setInterval(updateClock, 1000);"
echo "window.onload = updateClock;"
echo "</script>"
echo "<style>"
echo "body{font-family:Arial,sans-serif;padding:10px;margin:0}"
echo "body.dark{background:#1e1e2e;color:#cdd6f4}"
echo "body.light{background:#f5f5f5;color:#333}"
echo "table{border-collapse:collapse;margin:10px 0;box-shadow:0 0 10px rgba(0,0,0,0.1);width:100%}"
echo ".light table{background:white}"
echo ".dark table{background:#313244}"
echo "th,td{padding:8px 10px;border:1px solid #ddd;text-align:center;font-size:0.9em}"
echo ".dark th,.dark td{border:1px solid #45475a}"
echo "th{background:#f2f2f2}"
echo ".dark th{background:#45475a}"
echo ".form-box{padding:15px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1);margin:15px 0;max-width:600px}"
echo ".light .form-box{background:white}"
echo ".dark .form-box{background:#313244}"
echo "select,input[type=submit],input[type=number]{padding:6px;margin:3px;border-radius:4px;border:1px solid #ccc}"
echo ".dark select,.dark input[type=number]{background:#45475a;color:#cdd6f4;border:1px solid #585b70}"
echo "input[type=number]{width:55px;text-align:center}"
echo "input[type=submit]{background:#0066cc;color:white;border:none;cursor:pointer;padding:8px 16px}"
echo "label{margin-right:8px}"
echo ".del-btn{color:white;background:#d00;padding:4px 8px;border-radius:4px;text-decoration:none;font-size:0.85em}"
echo ".header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}"
echo ".header h1{margin:0;font-size:1.3em}"
echo ".time-box{background:#333;color:#0f0;padding:6px 12px;border-radius:8px;font-family:monospace;font-size:1em}"
echo "</style></head><body class='${BODY_CLASS}'>"
echo "<div class='header'>"
echo "<h1>‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</h1>"
echo "<div class='time-box' id='clock'>–∑–∞–≥—Ä—É–∑–∫–∞...</div>"
echo "</div>"
echo "<div class='form-box'>"
echo "<h3 style='margin-top:0'>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h3>"
echo "<form method='POST' action='/cgi-bin/schedule?theme=${THEME}'>"
echo "<p><strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</strong><br>"
echo "<select name='mac' style='width:100%'>"
echo "<option value='ALL'>üåê –í–°–ï –£–°–¢–†–û–ô–°–¢–í–ê (–∫—Ä–æ–º–µ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞)</option>"
while IFS=' ' read -r ts mac ip name rest; do
    [ "$name" = "*" ] && name="$mac"
    echo "<option value='$mac'>$name ($mac)</option>"
done < /tmp/dhcp.leases
echo "</select></p>"
echo "<p><strong>–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å:</strong> "
echo "<input type='number' name='hour_on' min='0' max='23' value='22'> —á"
echo "<input type='number' name='min_on' min='0' max='59' value='00'> –º–∏–Ω</p>"
echo "<p><strong>–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤:</strong> "
echo "<input type='number' name='hour_off' min='0' max='23' value='07'> —á"
echo "<input type='number' name='min_off' min='0' max='59' value='00'> –º–∏–Ω</p>"
echo "<p><strong>–î–Ω–∏:</strong><br>"
echo "<label><input type='checkbox' name='d_mon' checked> –ü–Ω</label>"
echo "<label><input type='checkbox' name='d_tue' checked> –í—Ç</label>"
echo "<label><input type='checkbox' name='d_wed' checked> –°—Ä</label>"
echo "<label><input type='checkbox' name='d_thu' checked> –ß—Ç</label>"
echo "<label><input type='checkbox' name='d_fri' checked> –ü—Ç</label>"
echo "<label><input type='checkbox' name='d_sat' checked> –°–±</label>"
echo "<label><input type='checkbox' name='d_sun' checked> –í—Å</label></p>"
echo "<input type='submit' value='üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å'>"
echo "</form></div>"
echo "<h2 style='font-size:1.1em'>üìã –¢–µ–∫—É—â–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2>"
if [ -f /etc/crontabs/root ] && grep -q "#SCHED_" /etc/crontabs/root; then
    echo "<table><tr><th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th><th>–í—Ä–µ–º—è</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>–î–Ω–∏</th><th>X</th></tr>"
    grep "#SCHED_" /etc/crontabs/root | while read line; do
        MIN=$(echo "$line" | awk '{print $1}')
        HOUR=$(echo "$line" | awk '{print $2}')
        CRON_DAYS=$(echo "$line" | awk '{print $5}')
        SMAC=$(echo "$line" | sed -n 's/.*#SCHED_\(.*\)/\1/p')
        if echo "$line" | grep -q "unblock"; then
            ACT="‚úÖ –†–∞–∑–±–ª–æ–∫"
        else
            ACT="‚õî –ë–ª–æ–∫"
        fi
        if [ "$SMAC" = "ALL" ]; then
            DEV_NAME="üåê –í–°–ï"
        else
            DEV_NAME=$(grep -i "$SMAC" /tmp/dhcp.leases | awk '{print $4}')
            [ -z "$DEV_NAME" ] || [ "$DEV_NAME" = "*" ] && DEV_NAME="$SMAC"
        fi
        DAYS_TEXT=$(echo "$CRON_DAYS" | sed 's/0/–í—Å/g;s/1/–ü–Ω/g;s/2/–í—Ç/g;s/3/–°—Ä/g;s/4/–ß—Ç/g;s/5/–ü—Ç/g;s/6/–°–±/g')
        printf "<tr><td>%s</td><td>%02d:%02d</td><td>%s</td><td>%s</td><td><a href='/cgi-bin/schedule_del?mac=%s' class='del-btn'>üóëÔ∏è</a></td></tr>\n" "$DEV_NAME" "$HOUR" "$MIN" "$ACT" "$DAYS_TEXT" "$SMAC"
    done
    echo "</table>"
else
    echo "<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π</p>"
fi
echo "</body></html>"
